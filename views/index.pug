doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Todo App
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet")
    style.
      body { background: #f8f9fa; min-height: 100vh; }
      .auth-section, .todo-section { display: none; }
      .auth-section.active, .todo-section.active { display: block; }
      .todo-item.completed { opacity: 0.7; }
      .edit-form { display: none; }
      .edit-form.active { display: block; }
  body
    .container.py-5
      #authSection.auth-section.active
        .row.justify-content-center
          .col-md-6.col-lg-5
            .card.shadow
              .card-body.p-4
                h1.card-title.text-center.mb-4
                  i.bi.bi-check2-square.text-primary
                  |  Todo App
                #loginForm
                  h2.text-center.mb-4 Login
                  .mb-3
                    label.form-label(for="loginEmail") Email
                    input#loginEmail.form-control(type="email" placeholder="Enter your email")
                  .mb-3
                    label.form-label(for="loginPassword") Password
                    input#loginPassword.form-control(type="password" placeholder="Enter your password")
                  button.btn.btn-primary.w-100.mb-3(onclick="handleLogin()")
                    i.bi.bi-box-arrow-in-right
                    |  Login
                  .text-center
                    | Don't have an account? 
                    a.text-primary(style="cursor:pointer" onclick="showSignup()") Sign Up
                  #loginError.alert.alert-danger(style="display:none" role="alert")
                #signupForm(style="display:none")
                  h2.text-center.mb-4 Sign Up
                  .mb-3
                    label.form-label(for="signupName") Name
                    input#signupName.form-control(type="text" placeholder="Enter your name")
                  .mb-3
                    label.form-label(for="signupEmail") Email
                    input#signupEmail.form-control(type="email" placeholder="Enter your email")
                  .mb-3
                    label.form-label(for="signupPassword") Password
                    input#signupPassword.form-control(type="password" placeholder="Enter your password")
                  button.btn.btn-success.w-100.mb-3(onclick="handleSignup()")
                    i.bi.bi-person-plus
                    |  Sign Up
                  .text-center
                    | Already have an account? 
                    a.text-primary(style="cursor:pointer" onclick="showLogin()") Login
                  #signupError.alert.alert-danger(style="display:none" role="alert")

      #todoSection.todo-section
        .card.shadow.mb-4
          .card-header.bg-primary.text-white
            .d-flex.justify-content-between.align-items-center
              h3.mb-0
                i.bi.bi-list-check
                |  My Todos
              .d-flex.align-items-center.gap-2
                span.badge.bg-light.text-dark
                  i.bi.bi-person-circle
                  |  
                  span#userName
                button.btn.btn-sm.btn-outline-light(onclick="handleLogout()")
                  i.bi.bi-box-arrow-right
                  |  Logout
        
        .card.shadow.mb-4
          .card-body
            h5.card-title.mb-3
              i.bi.bi-plus-circle
              |  Add New Todo
            .mb-3
              label.form-label(for="newTodoTitle") Title
              input#newTodoTitle.form-control(type="text" placeholder="Enter todo title")
            .mb-3
              label.form-label(for="newTodoDescription") Description
              textarea#newTodoDescription.form-control(rows="2" placeholder="Enter description (optional)")
            .mb-3
              label.form-label(for="newTodoStatus") Status
              select#newTodoStatus.form-select
                option(value="pending") Pending
                option(value="in-progress") In Progress
                option(value="completed") Completed
            button.btn.btn-success.w-100(onclick="createTodo()")
              i.bi.bi-plus-lg
              |  Add Todo
            #addError.alert.alert-danger.mt-3(style="display:none" role="alert")

        #todosList

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script.
      const API_BASE = '/api/v1';
      let currentUser = null;

      function getToken() {
        return localStorage.getItem('authToken') || '';
      }

      function setToken(token) {
        localStorage.setItem('authToken', token);
      }

      function clearToken() {
        localStorage.removeItem('authToken');
        currentUser = null;
      }

      function getHeaders() {
        return {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        };
      }

      function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
      }

      function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
      }

      function showSignup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
      }

      async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
          showError('loginError', 'Please fill all fields');
          return;
        }
        try {
          const res = await fetch(API_BASE + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json();
          if (res.ok && data.token) {
            setToken(data.token);
            await loadUserProfile();
            showTodoSection();
          } else {
            showError('loginError', data.message || 'Login failed');
          }
        } catch (e) {
          showError('loginError', 'Error: ' + e.message);
        }
      }

      async function handleSignup() {
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        if (!name || !email || !password) {
          showError('signupError', 'Please fill all fields');
          return;
        }
        try {
          const res = await fetch(API_BASE + '/auth/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
          });
          const data = await res.json();
          if (res.ok && data.token) {
            setToken(data.token);
            currentUser = data.user;
            showTodoSection();
          } else {
            showError('signupError', data.message || 'Signup failed');
          }
        } catch (e) {
          showError('signupError', 'Error: ' + e.message);
        }
      }

      async function loadUserProfile() {
        try {
          const res = await fetch(API_BASE + '/auth/profile', {
            headers: getHeaders()
          });
          const data = await res.json();
          if (res.ok) {
            currentUser = data.user;
          }
        } catch (e) {
          console.error('Error loading profile:', e);
        }
      }

      function showTodoSection() {
        document.getElementById('authSection').classList.remove('active');
        document.getElementById('todoSection').classList.add('active');
        if (currentUser) {
          document.getElementById('userName').textContent = currentUser.name || currentUser.email;
        }
        loadTodos();
      }

      async function handleLogout() {
        try {
          await fetch(API_BASE + '/auth/logout', {
            headers: getHeaders()
          });
        } catch (e) {
          console.error('Logout error:', e);
        }
        clearToken();
        document.getElementById('authSection').classList.add('active');
        document.getElementById('todoSection').classList.remove('active');
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
      }

      async function createTodo() {
        const title = document.getElementById('newTodoTitle').value;
        const description = document.getElementById('newTodoDescription').value;
        const status = document.getElementById('newTodoStatus').value;
        if (!title) {
          showError('addError', 'Title is required');
          return;
        }
        try {
          const res = await fetch(API_BASE + '/todo/createTodo', {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ title, description, status })
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById('newTodoTitle').value = '';
            document.getElementById('newTodoDescription').value = '';
            loadTodos();
          } else {
            showError('addError', data.message || 'Failed to create todo');
          }
        } catch (e) {
          showError('addError', 'Error: ' + e.message);
        }
      }

      async function loadTodos() {
        try {
          const res = await fetch(API_BASE + '/todo/getTodos', {
            headers: getHeaders()
          });
          const data = await res.json();
          if (res.ok) {
            renderTodos(data.todos || []);
          }
        } catch (e) {
          console.error('Error loading todos:', e);
        }
      }

      function getStatusBadgeClass(status) {
        if (status == 'completed') return 'bg-success';
        if (status =='in-progress') return 'bg-info';
        return 'bg-warning text-dark';
      }

      function renderTodos(todos) {
        const container = document.getElementById('todosList');
        if (todos.length == 0) {
          container.innerHTML = `
            <div class="card shadow">
              <div class="card-body text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-3">No todos yet. Add one above!</p>
              </div>
            </div>
          `;
          return;
        }
        container.innerHTML = todos.map(todo => `
          <div class="card shadow-sm mb-3 todo-item ${todo.status == 'completed' ? 'completed' : ''}" id="todo-${todo._id}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">${todo.title}</h5>
                <span class="badge ${getStatusBadgeClass(todo.status)}">${todo.status}</span>
              </div>
              ${todo.description ? `<p class="card-text text-muted">${todo.description}</p>` : ''}
              <div class="btn-group mt-3" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editTodo('${todo._id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo('${todo._id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
              <div class="edit-form mt-3" id="edit-${todo._id}">
                <div class="mb-2">
                  <label class="form-label">Title</label>
                  <input type="text" class="form-control" id="edit-title-${todo._id}" value="${todo.title}">
                </div>
                <div class="mb-2">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="edit-desc-${todo._id}" rows="2">${todo.description || ''}</textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Status</label>
                  <select class="form-select" id="edit-status-${todo._id}">
                    <option value="pending" ${todo.status == 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in-progress" ${todo.status == 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${todo.status == 'completed' ? 'selected' : ''}>Completed</option>
                  </select>
                </div>
                <div class="btn-group">
                  <button class="btn btn-sm btn-success" onclick="saveTodo('${todo._id}')">
                    <i class="bi bi-check-lg"></i> Save
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="cancelEdit('${todo._id}')">
                    <i class="bi bi-x-lg"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function editTodo(id) {
        document.getElementById('edit-' + id).classList.add('active');
      }

      function cancelEdit(id) {
        document.getElementById('edit-' + id).classList.remove('active');
      }

      async function saveTodo(id) {
        const title = document.getElementById('edit-title-' + id).value;
        const description = document.getElementById('edit-desc-' + id).value;
        const status = document.getElementById('edit-status-' + id).value;
        if (!title) {
          alert('Title is required');
          return;
        }
        try {
          const res = await fetch(API_BASE + '/todo/updateTodo/' + id, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify({ title, description, status })
          });
          const data = await res.json();
          if (res.ok) {
            cancelEdit(id);
            loadTodos();
          } else {
            alert(data.message || 'Failed to update');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      async function deleteTodo(id) {
        if (!confirm('Delete this todo?')) return;
        try {
          const res = await fetch(API_BASE + '/todo/deleteTodo/' + id, {
            method: 'DELETE',
            headers: getHeaders()
          });
          if (res.ok) {
            loadTodos();
          } else {
            const data = await res.json();
            alert(data.message || 'Failed to delete');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      window.onload = async function() {
        if (getToken()) {
          await loadUserProfile();
          showTodoSection();
        }
      };
